<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YunManGongFangAI</title>
    <link rel="icon" href="https://img.yunmanybcz.chat/yunmanlogo.png" type="image/png">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #8b5cf6;
            --secondary-color: #3b82f6;
            --bg-color: #050505;
            --text-color: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        #bgCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        /* åå°ç®¡ç†å¸ƒå±€ */
        .admin-container {
            position: relative;
            z-index: 10;
            display: flex;
            height: 100vh;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 280px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            padding: 30px 0;
            display: flex;
            flex-direction: column;
        }

        .admin-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 30px 30px;
            border-bottom: 1px solid var(--glass-border);
            margin-bottom: 30px;
        }

        .admin-logo i {
            font-size: 28px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .admin-logo span {
            font-size: 18px;
            font-weight: 700;
        }

        .nav-menu {
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 30px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(139, 92, 246, 0.1);
            color: #fff;
            border-left-color: var(--primary-color);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .admin-user {
            padding: 20px 30px;
            border-top: 1px solid var(--glass-border);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-details h4 {
            font-size: 14px;
            margin-bottom: 2px;
        }

        .user-details span {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header-title h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header-title p {
            color: rgba(255, 255, 255, 0.6);
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
            animation: borderFlow 3s linear infinite;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .stat-icon.primary { background: rgba(139, 92, 246, 0.2); color: var(--primary-color); }
        .stat-icon.success { background: rgba(16, 185, 129, 0.2); color: var(--success-color); }
        .stat-icon.warning { background: rgba(245, 158, 11, 0.2); color: var(--warning-color); }
        .stat-icon.danger { background: rgba(239, 68, 68, 0.2); color: var(--danger-color); }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .table-container {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            overflow: hidden;
        }

        .table-header {
            padding: 25px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-success { background: var(--success-color); color: white; }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: rgba(255, 255, 255, 0.8);
        }

        .btn:hover { transform: translateY(-2px); }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px 25px;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
        }

        th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active { background: rgba(16, 185, 129, 0.2); color: var(--success-color); }
        .status-expired { background: rgba(239, 68, 68, 0.2); color: var(--danger-color); }
        .status-pending { background: rgba(245, 158, 11, 0.2); color: var(--warning-color); }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            padding: 30px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 20px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.8);
        }

        .form-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            padding: 12px 15px;
            border-radius: 10px;
            color: #fff;
            font-size: 14px;
        }

        .form-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        @keyframes borderFlow {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: 100%; }
        }

        .loader {
            width: 20px; height: 20px;
            border: 2px solid #fff; border-bottom-color: transparent;
            border-radius: 50%;
            animation: rotation 1s linear infinite;
            display: inline-block;
        }

        @keyframes rotation {
            0% {transform: rotate(0deg);}
            100% {transform: rotate(360deg);}
        }

        /* åˆ†é¡µæ ·å¼ */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-top: 1px solid var(--glass-border);
        }

        .pagination-info {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .page-btn {
            padding: 8px 16px;
            border: 1px solid var(--glass-border);
            background: transparent;
            color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .page-btn:hover:not(:disabled) {
            background: rgba(139, 92, 246, 0.2);
            border-color: var(--primary-color);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-numbers {
            display: flex;
            gap: 5px;
        }

        .page-number {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .page-number:hover, .page-number.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-color: var(--primary-color);
        }

        .page-input {
            width: 60px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: #fff;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- åŠ¨æ€èƒŒæ™¯ -->
    <canvas id="bgCanvas"></canvas>

    <!-- åå°ç®¡ç†å¸ƒå±€ -->
    <div class="admin-container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="admin-logo">
                <i class="fa-solid fa-robot"></i>
                <span>YunManGongFangAI</span>
            </div>

            <div class="nav-menu">
                <a href="#" class="nav-item active" data-tab="dashboard">
                    <i class="fa-solid fa-chart-line"></i>
                    <span>æ•°æ®çœ‹æ¿</span>
                </a>
                <a href="#" class="nav-item" data-tab="codes">
                    <i class="fa-solid fa-key"></i>
                    <span>é‚€è¯·ç ç®¡ç†</span>
                </a>
                <a href="#" class="nav-item" data-tab="users">
                    <i class="fa-solid fa-users"></i>
                    <span>ç”¨æˆ·ç®¡ç†</span>
                </a>
                <a href="#" class="nav-item" data-tab="analytics">
                    <i class="fa-solid fa-chart-pie"></i>
                    <span>æ•°æ®åˆ†æ</span>
                </a>
            </div>

            <div class="admin-user">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <div class="user-details">
                        <h4>ç®¡ç†å‘˜</h4>
                        <span>è¶…çº§ç®¡ç†å‘˜</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- æ•°æ®çœ‹æ¿ -->
            <div class="content-tab" id="dashboard-tab">
                <div class="content-header">
                    <div class="header-title">
                        <h1>æ•°æ®çœ‹æ¿</h1>
                        <p>ç³»ç»Ÿå®æ—¶æ•°æ®ç»Ÿè®¡å’Œåˆ†æ</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-outline" onclick="refreshData()">
                            <i class="fa-solid fa-rotate"></i>åˆ·æ–°æ•°æ®
                        </button>
                    </div>
                </div>

                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon primary">
                            <i class="fa-solid fa-key"></i>
                        </div>
                        <div class="stat-value" id="total-codes">0</div>
                        <div class="stat-label">æ€»é‚€è¯·ç æ•°é‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon success">
                            <i class="fa-solid fa-users"></i>
                        </div>
                        <div class="stat-value" id="active-users">0</div>
                        <div class="stat-label">æ´»è·ƒç”¨æˆ·æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning">
                            <i class="fa-solid fa-chart-line"></i>
                        </div>
                        <div class="stat-value" id="today-usage">0</div>
                        <div class="stat-label">ä»Šæ—¥ä½¿ç”¨æ¬¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon danger">
                            <i class="fa-solid fa-clock"></i>
                        </div>
                        <div class="stat-value" id="expiring-codes">0</div>
                        <div class="stat-label">å³å°†è¿‡æœŸ</div>
                    </div>
                </div>

                <!-- å®æ—¶ä½¿ç”¨æƒ…å†µ -->
                <div class="table-container">
                    <div class="table-header">
                        <h3>å®æ—¶ä½¿ç”¨æƒ…å†µ</h3>
                        <div class="table-actions">
                            <button class="btn btn-outline">
    <i class="fa-solid fa-download"></i>å¯¼å‡º
</button>

<button class="btn btn-outline" onclick="exportUsageData()">
    <i class="fa-solid fa-download"></i>å¯¼å‡º Excel
</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>é‚€è¯·ç </th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>è¿‡æœŸæ—¶é—´</th>
                                <th>çŠ¶æ€</th>
                                <th>ç»‘å®šè®¾å¤‡</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="usage-table-body">
                            <!-- åŠ¨æ€åŠ è½½æ•°æ® -->
                        </tbody>
                    </table>
                    <!-- åˆ†é¡µæ§ä»¶ -->
                    <div class="pagination" id="usage-pagination">
                        <div class="pagination-info" id="usage-page-info">ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</div>
                        <div class="pagination-controls">
                            <button class="page-btn" onclick="changeUsagePage('first')" disabled>
                                <i class="fa-solid fa-angles-left"></i>
                            </button>
                            <button class="page-btn" onclick="changeUsagePage('prev')" disabled>
                                <i class="fa-solid fa-chevron-left"></i>
                            </button>

                            <div class="page-numbers" id="usage-page-numbers">
                                <span class="page-number active">1</span>
                            </div>

                            <button class="page-btn" onclick="changeUsagePage('next')" disabled>
                                <i class="fa-solid fa-chevron-right"></i>
                            </button>
                            <button class="page-btn" onclick="changeUsagePage('last')" disabled>
                                <i class="fa-solid fa-angles-right"></i>
                            </button>

                            <input type="number" class="page-input" id="usage-page-input" min="1" value="1"
                                   onchange="goToUsagePage(this.value)" placeholder="é¡µç ">
                        </div>
                    </div>
                </div>
            </div>

            <!-- é‚€è¯·ç ç®¡ç† -->
            <div class="content-tab" id="codes-tab" style="display: none;">
                <div class="content-header">
                    <div class="header-title">
                        <h1>é‚€è¯·ç ç®¡ç†</h1>
                        <p>åˆ›å»ºå’Œç®¡ç†é‚€è¯·ç </p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="showCreateModal()">
                            <i class="fa-solid fa-plus"></i>åˆ›å»ºé‚€è¯·ç 
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h3>é‚€è¯·ç åˆ—è¡¨</h3>
                        <div class="table-actions">
                            <input type="text" class="form-input" id="codes-search-input"
                                   placeholder="æœç´¢é‚€è¯·ç ..." style="width: 200px;" oninput="searchCodes()">
                            <button class="btn btn-outline" onclick="filterCodes()">
                                <i class="fa-solid fa-filter"></i>ç­›é€‰
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>é‚€è¯·ç </th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>è¿‡æœŸæ—¶é—´</th>
                                <th>çŠ¶æ€</th>
                                <th>å‰©ä½™å¤©æ•°</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="codes-table-body">
                            <!-- åŠ¨æ€åŠ è½½æ•°æ® -->
                        </tbody>
                    </table>
                    <!-- åˆ†é¡µæ§ä»¶ -->
                    <div class="pagination" id="codes-pagination">
                        <div class="pagination-info" id="codes-page-info">ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</div>
                        <div class="pagination-controls">
                            <button class="page-btn" onclick="changeCodesPage('first')" disabled>
                                <i class="fa-solid fa-angles-left"></i>
                            </button>
                            <button class="page-btn" onclick="changeCodesPage('prev')" disabled>
                                <i class="fa-solid fa-chevron-left"></i>
                            </button>

                            <div class="page-numbers" id="codes-page-numbers">
                                <span class="page-number active">1</span>
                            </div>

                            <button class="page-btn" onclick="changeCodesPage('next')" disabled>
                                <i class="fa-solid fa-chevron-right"></i>
                            </button>
                            <button class="page-btn" onclick="changeCodesPage('last')" disabled>
                                <i class="fa-solid fa-angles-right"></i>
                            </button>

                            <input type="number" class="page-input" id="codes-page-input" min="1" value="1"
                                   onchange="goToCodesPage(this.value)" placeholder="é¡µç ">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºé‚€è¯·ç æ¨¡æ€æ¡† -->
    <div class="modal" id="createModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>åˆ›å»ºé‚€è¯·ç </h3>
                <button class="modal-close" onclick="hideCreateModal()">&times;</button>
            </div>
            <form id="createCodeForm">
                <div class="form-group">
                    <label class="form-label">åˆ›å»ºæ•°é‡</label>
                    <input type="number" class="form-input" id="createCount" value="1" min="1" max="50" required>
                    <small style="color: rgba(255,255,255,0.5); font-size: 12px;">æœ€å¤šå¯æ‰¹é‡åˆ›å»º50ä¸ª</small>
                </div>
                <div class="form-group">
                    <label class="form-label">é‚€è¯·ç å‰ç¼€ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" class="form-input" id="codePrefix" placeholder="è¾“å…¥å‰ç¼€ï¼Œç•™ç©ºåˆ™å®Œå…¨éšæœºç”Ÿæˆ" maxlength="10">
                </div>
                <div class="form-group">
                    <label class="form-label">æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰</label>
                    <input type="number" class="form-input" id="expiryDays" value="7" min="1" max="365" required>
                </div>
                <div class="form-group">
                    <label class="form-label">å¤‡æ³¨ä¿¡æ¯</label>
                    <input type="text" class="form-input" id="codeNote" placeholder="å¯é€‰å¤‡æ³¨ä¿¡æ¯">
                </div>
                <div class="form-actions" style="display: flex; gap: 15px; margin-top: 25px;">
                    <button type="button" class="btn btn-outline" onclick="hideCreateModal()" style="flex: 1;">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <span id="createBtnText">åˆ›å»º</span>
                        <span id="createBtnLoader" class="loader" style="display: none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
<div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¼–è¾‘é‚€è¯·ç </h3>
                <button class="modal-close" onclick="hideEditModal()">&times;</button>
            </div>
            <form id="editCodeForm">
                <input type="hidden" id="editCodeValue">

                <div class="form-group">
                    <label class="form-label">å½“å‰é‚€è¯·ç </label>
                    <input type="text" class="form-input" id="editCodeDisplay" disabled style="opacity: 0.7;">
                </div>

                <div class="form-group">
                    <label class="form-label">ä¿®æ”¹è¿‡æœŸæ—¶é—´</label>
                    <input type="date" class="form-input" id="editExpiryDate">
                    <small style="color: rgba(255,255,255,0.5); font-size: 12px;">ç•™ç©ºåˆ™ä¸ä¿®æ”¹æ—¶é—´</small>
                </div>

                <div class="form-group" style="display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px;">
                    <input type="checkbox" id="resetDeviceCheck" style="width: 20px; height: 20px;">
                    <div>
                        <label for="resetDeviceCheck" style="font-weight: bold; cursor: pointer;">é‡ç½®è®¾å¤‡ç»‘å®š</label>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.6);">å‹¾é€‰åå°†æ¸…ç©ºè¯¥ç ç»‘å®šçš„æ‰€æœ‰è®¾å¤‡ï¼Œå…è®¸æ–°è®¾å¤‡ç™»å½•</div>
                    </div>
                </div>

                <div class="form-actions" style="display: flex; gap: 15px; margin-top: 25px;">
                    <button type="button" class="btn btn-outline" onclick="hideEditModal()" style="flex: 1;">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </form>
        </div>
    </div>
    <div class="modal" id="viewModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>é‚€è¯·ç è¯¦æƒ…</h3>
                <button class="modal-close" onclick="hideViewModal()">&times;</button>
            </div>

            <div style="display: flex; flex-direction: column; gap: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" style="font-size: 12px; color: rgba(255,255,255,0.5);">é‚€è¯·ç </label>
                        <div id="viewCodeDisplay" style="font-size: 18px; font-weight: bold; font-family: monospace; color: var(--primary-color);"></div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" style="font-size: 12px; color: rgba(255,255,255,0.5);">åˆ°æœŸæ—¶é—´</label>
                        <div id="viewExpiryDisplay" style="font-size: 16px;"></div>
                    </div>
                </div>

                <div style="height: 1px; background: var(--glass-border);"></div>

                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label class="form-label" style="margin-bottom: 0;">å·²ç»‘å®šè®¾å¤‡åˆ—è¡¨</label>
                        <span id="viewDeviceCount" class="status-badge status-active">0 å°</span>
                    </div>

                    <div id="viewDeviceList" style="
                        background: rgba(0, 0, 0, 0.4);
                        border: 1px solid var(--glass-border);
                        border-radius: 10px;
                        padding: 10px;
                        max-height: 250px;
                        overflow-y: auto;
                        font-family: monospace;
                        font-size: 13px;
                    ">
                        </div>
                </div>

                <div class="form-actions" style="margin-top: 10px; text-align: right;">
                    <button type="button" class="btn btn-primary" onclick="hideViewModal()">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        /**
         * 1. åŠ¨æ€ç²’å­èƒŒæ™¯ç‰¹æ•ˆ
         */
        const canvas = document.getElementById('bgCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let particles = [];
        let mouse = { x: null, y: null, radius: 200 };

        window.addEventListener('mousemove', (event) => {
            mouse.x = event.x;
            mouse.y = event.y;
        });

        window.addEventListener('mouseout', () => {
            mouse.x = null;
            mouse.y = null;
        });

        const properties = {
            bgColor: 'rgba(5, 5, 5, 1)',
            particleColor: 'rgba(139, 92, 246, 0.8)',
            particleRadius: 2,
            particleCount: 150,
            particleVelocity: 0.8,
            lineLength: 120,
        };

        function initSize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }

        window.onresize = initSize;

        class Particle {
            constructor() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.velocityX = Math.random() * (properties.particleVelocity * 2) - properties.particleVelocity;
                this.velocityY = Math.random() * (properties.particleVelocity * 2) - properties.particleVelocity;
                this.size = Math.random() * 2 + 1;
            }

            position() {
                if(this.x > width || this.x < 0) this.velocityX *= -1;
                if(this.y > height || this.y < 0) this.velocityY *= -1;
                this.x += this.velocityX;
                this.y += this.velocityY;
            }

            reDraw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.closePath();
                ctx.fillStyle = properties.particleColor;
                ctx.fill();
            }
        }

        function reDrawBackground() {
            ctx.fillStyle = properties.bgColor;
            ctx.fillRect(0, 0, width, height);
        }

        function drawLines() {
            let x1, y1, x2, y2, length, opacity;
            for (let i in particles) {
                for (let j in particles) {
                    x1 = particles[i].x; y1 = particles[i].y;
                    x2 = particles[j].x; y2 = particles[j].y;
                    length = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));

                    if (length < properties.lineLength) {
                        opacity = 1 - length / properties.lineLength;
                        ctx.lineWidth = '0.5';
                        ctx.strokeStyle = `rgba(139, 92, 246, ${opacity})`;
                        ctx.beginPath();
                        ctx.moveTo(x1, y1);
                        ctx.lineTo(x2, y2);
                        ctx.stroke();
                        ctx.closePath();
                    }
                }

                if (mouse.x != null) {
                    let mouseDist = Math.sqrt(Math.pow(mouse.x - particles[i].x, 2) + Math.pow(mouse.y - particles[i].y, 2));
                    if (mouseDist < mouse.radius) {
                        ctx.lineWidth = '1';
                        ctx.strokeStyle = `rgba(59, 130, 246, ${1 - mouseDist/mouse.radius})`;
                        ctx.beginPath();
                        ctx.moveTo(particles[i].x, particles[i].y);
                        ctx.lineTo(mouse.x, mouse.y);
                        ctx.stroke();
                        ctx.closePath();
                    }
                }
            }
        }

        function loop() {
            reDrawBackground();
            for (let i in particles) {
                particles[i].position();
                particles[i].reDraw();
            }
            drawLines();
            requestAnimationFrame(loop);
        }

        function initParticles() {
            particles = [];
            let count = window.innerWidth > 1000 ? 150 : 80;
            for (let i = 0; i < count; i++) {
                particles.push(new Particle());
            }
            loop();
        }

        initSize();
        initParticles();

        /**
         * 2. åå°ç®¡ç†åŠŸèƒ½ - ä½¿ç”¨çœŸå®APIæ•°æ®
         */
        // åˆ†é¡µç›¸å…³å˜é‡
        const paginationConfig = {
            pageSize: 20, // æ¯é¡µæ˜¾ç¤º20è¡Œ
            usage: {
                currentPage: 1,
                totalPages: 1,
                totalItems: 0,
                data: []
            },
            codes: {
                currentPage: 1,
                totalPages: 1,
                totalItems: 0,
                data: [],
                searchTerm: '',
                filteredData: []
            }
        };

        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();

                // æ›´æ–°æ¿€æ´»çŠ¶æ€
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');

                // æ˜¾ç¤ºå¯¹åº”æ ‡ç­¾é¡µ
                const tabName = this.getAttribute('data-tab');
                document.querySelectorAll('.content-tab').forEach(tab => tab.style.display = 'none');
                document.getElementById(`${tabName}-tab`).style.display = 'block';

                // åŠ è½½å¯¹åº”æ•°æ®
                if (tabName === 'dashboard') loadDashboardData();
                if (tabName === 'codes') loadCodesData();
            });
        });

        // æ¨¡æ€æ¡†æ§åˆ¶
        function showCreateModal() {
            document.getElementById('createModal').style.display = 'flex';
            // é‡ç½®è¡¨å•
            document.getElementById('createCodeForm').reset();
            document.getElementById('createCount').value = 1;
        }

        function hideCreateModal() {
            document.getElementById('createModal').style.display = 'none';
        }

        // åˆ›å»ºé‚€è¯·ç è¡¨å•æäº¤ï¼ˆæ‰¹é‡åˆ›å»ºï¼‰
        document.getElementById('createCodeForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const createCount = parseInt(document.getElementById('createCount').value);
            const codePrefix = document.getElementById('codePrefix').value.trim();
            const expiryDays = parseInt(document.getElementById('expiryDays').value);
            const note = document.getElementById('codeNote').value;

            // éªŒè¯æ•°é‡
            if (createCount < 1 || createCount > 50) {
                showNotification('åˆ›å»ºæ•°é‡å¿…é¡»åœ¨1-50ä¹‹é—´', 'error');
                return;
            }

            const createBtn = this.querySelector('button[type="submit"]');
            const btnText = createBtn.querySelector('#createBtnText');
            const loader = createBtn.querySelector('#createBtnLoader');

            btnText.style.display = 'none';
            loader.style.display = 'inline-block';
            createBtn.disabled = true;

            try {
                // ä½¿ç”¨çœŸå®APIè°ƒç”¨
                const response = await fetch('/admin/codes/batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        count: createCount,
                        prefix: codePrefix || undefined,
                        expires_days: expiryDays,
                        note: note
                    })
                });

                const result = await response.json();

                if (result.success) {
                    hideCreateModal();
                    this.reset();
                    document.getElementById('createCount').value = 1; // é‡ç½®æ•°é‡
                    showNotification(`æˆåŠŸåˆ›å»º ${result.created_count} ä¸ªé‚€è¯·ç `, 'success');
                    loadCodesData(); // é‡æ–°åŠ è½½æ•°æ®
                } else {
                    showNotification(result.message || 'åˆ›å»ºå¤±è´¥', 'error');
                }
            } catch (error) {
                showNotification('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            } finally {
                btnText.style.display = 'inline';
                loader.style.display = 'none';
                createBtn.disabled = false;
            }
        });

        // æ·»åŠ æ•°é‡è¾“å…¥æ¡†çš„å®æ—¶éªŒè¯
        document.getElementById('createCount').addEventListener('input', function() {
            const value = parseInt(this.value);
            if (value < 1) this.value = 1;
            if (value > 50) this.value = 50;
        });

        // åŠ è½½æ•°æ®çœ‹æ¿ - ä½¿ç”¨çœŸå®API
       // åœ¨loadDashboardDataå‡½æ•°ä¸­ï¼Œå°†URLæ”¹ä¸ºæ­£ç¡®çš„è·¯å¾„
async function loadDashboardData() {
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        document.getElementById('total-codes').innerHTML = '<i class="fa fa-spinner fa-spin" style="font-size:16px"></i>';
        document.getElementById('active-users').innerHTML = '<i class="fa fa-spinner fa-spin" style="font-size:16px"></i>';
        document.getElementById('today-usage').innerHTML = '<i class="fa fa-spinner fa-spin" style="font-size:16px"></i>';
        document.getElementById('expiring-codes').innerHTML = '<i class="fa fa-spinner fa-spin" style="font-size:16px"></i>';

        // ä½¿ç”¨çœŸå®APIè°ƒç”¨ - ä¿®å¤URLè·¯å¾„
        const response = await fetch('/admin/api/dashboard/paginated?page=1&page_size=20', {
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
        }

        const data = await response.json();
        console.log('çœŸå®ä»ªè¡¨æ¿æ•°æ®:', data);

        if (data.success) {
            // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
            document.getElementById('total-codes').textContent = data.stats.total_codes;
            document.getElementById('active-users').textContent = data.stats.active_users;
            document.getElementById('today-usage').textContent = data.stats.today_usage;
            document.getElementById('expiring-codes').textContent = data.stats.expiring_codes;

            // æ›´æ–°åˆ†é¡µæ•°æ®
            paginationConfig.usage.data = data.usage_data || [];
            paginationConfig.usage.totalItems = data.pagination.total_items;
            paginationConfig.usage.totalPages = data.pagination.total_pages;
            paginationConfig.usage.currentPage = data.pagination.current_page;

            displayUsagePageData();
        }
    } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
        showNotification('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message, 'error');

        // å‡ºé”™æ—¶æ˜¾ç¤º0è€Œä¸æ˜¯ä¿æŒåŠ è½½çŠ¶æ€
        document.getElementById('total-codes').textContent = '0';
        document.getElementById('active-users').textContent = '0';
        document.getElementById('today-usage').textContent = '0';
        document.getElementById('expiring-codes').textContent = '0';
    }
}

        // æ›´æ–°ä½¿ç”¨æƒ…å†µè¡¨æ ¼
        function updateUsageTable(usageData) {
            const tbody = document.getElementById('usage-table-body');

            if (!usageData || usageData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">
                            <i class="fa-solid fa-inbox" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                            æš‚æ— ä½¿ç”¨æ•°æ®
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = usageData.map(item => {
        // è§£æç»‘å®šè®¾å¤‡
        let deviceDisplay = '<span style="color:rgba(255,255,255,0.3)">æ— </span>';
        if (item.bound_devices) {
            try {
                // å…¼å®¹å­—ç¬¦ä¸²JSONå’Œæ•°ç»„å¯¹è±¡
                const devices = typeof item.bound_devices === 'string' ? JSON.parse(item.bound_devices) : item.bound_devices;
                if (Array.isArray(devices) && devices.length > 0) {
                    deviceDisplay = `<span class="status-badge status-active" title="${devices.join('\n')}">å·²ç»‘ ${devices.length} å°</span>`;
                }
            } catch(e) {}
        }

        return `
        <tr>
            <td>${item.code || 'N/A'}</td>
            <td>${item.created_at ? new Date(item.created_at).toLocaleString() : 'æœªçŸ¥'}</td>
            <td>${item.expires_at ? new Date(item.expires_at).toLocaleString() : 'æ°¸ä¹…'}</td>
            <td><span class="status-badge ${getStatusClass(item)}">${getStatusText(item)}</span></td>
            <td>${deviceDisplay}</td> <td>
                <button class="btn btn-outline" style="padding: 5px 10px; font-size: 12px;"
                        onclick="viewUsageDetails('${item.code}')" title="æŸ¥çœ‹è¯¦æƒ…">
                    <i class="fa-solid fa-eye"></i> æŸ¥çœ‹
                </button>
            </td>
        </tr>
    `}).join('');
}

        // ================= ğŸš€ æ–°å¢ï¼šæŸ¥çœ‹è¯¦æƒ…å¼¹çª—é€»è¾‘ =================

        // æ‰“å¼€æŸ¥çœ‹è¯¦æƒ…å¼¹çª—
        window.viewUsageDetails = function(code) {
            // 1. ä»å½“å‰é¡µé¢çš„ç¼“å­˜æ•°æ®ä¸­æ‰¾åˆ°è¿™æ¡è®°å½•
            // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨çš„æ˜¯ usage (æ•°æ®çœ‹æ¿) çš„æ•°æ®æº
            const item = paginationConfig.usage.data.find(i => i.code === code);

            if (!item) {
                showNotification('æœªæ‰¾åˆ°è¯¥é‚€è¯·ç æ•°æ®', 'error');
                return;
            }

            // 2. å¡«å……åŸºç¡€ä¿¡æ¯
            document.getElementById('viewCodeDisplay').textContent = item.code;
            document.getElementById('viewExpiryDisplay').textContent = item.expires_at ? new Date(item.expires_at).toLocaleString() : 'æ°¸ä¹…æœ‰æ•ˆ';

            // 3. è§£æå¹¶æ¸²æŸ“è®¾å¤‡åˆ—è¡¨
            const deviceListEl = document.getElementById('viewDeviceList');
            const countEl = document.getElementById('viewDeviceCount');

            let devices = [];
            try {
                // è§£ææ•°æ®åº“é‡Œçš„ JSON å­—ç¬¦ä¸²
                if (item.bound_devices) {
                    devices = typeof item.bound_devices === 'string' ? JSON.parse(item.bound_devices) : item.bound_devices;
                }
            } catch (e) {
                console.error("è§£æè®¾å¤‡JSONå¤±è´¥", e);
            }

            // æ›´æ–°æ•°é‡è§’æ ‡
            countEl.textContent = (devices ? devices.length : 0) + ' å°';

            // æ¸²æŸ“åˆ—è¡¨ HTML
            if (devices && devices.length > 0) {
                deviceListEl.innerHTML = devices.map((devId, index) => `
                    <div style="
                        padding: 8px;
                        border-bottom: 1px solid rgba(255,255,255,0.05);
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    ">
                        <span style="color: var(--primary-color); opacity: 0.7;">#${index + 1}</span>
                        <span style="word-break: break-all; color: #fff;">${devId}</span>
                    </div>
                `).join('');
            } else {
                deviceListEl.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.3);">
                        <i class="fa-solid fa-mobile-screen" style="font-size: 24px; margin-bottom: 5px;"></i>
                        <div>æš‚æ— ç»‘å®šè®¾å¤‡</div>
                    </div>
                `;
            }

            // 4. æ˜¾ç¤ºå¼¹çª—
            document.getElementById('viewModal').style.display = 'flex';
        }

        function hideViewModal() {
            document.getElementById('viewModal').style.display = 'none';
        }

        // åŠ è½½é‚€è¯·ç åˆ—è¡¨ - ä½¿ç”¨çœŸå®API
        async function loadCodesData() {
            try {
                showLoading('codes-table-body');

                // ä½¿ç”¨çœŸå®APIè°ƒç”¨
                const response = await fetch('/admin/codes/paginated?page=1&page_size=20', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    // æ›´æ–°åˆ†é¡µæ•°æ®
                    paginationConfig.codes.data = data.codes || [];
                    paginationConfig.codes.totalItems = data.pagination.total_items;
                    paginationConfig.codes.totalPages = data.pagination.total_pages;
                    paginationConfig.codes.currentPage = data.pagination.current_page;
                    paginationConfig.codes.searchTerm = '';

                    displayCodesPageData();

                    // æ˜¾ç¤ºçœŸå®æ•°æ®é‡
                    console.log(`ä»æ•°æ®åº“åŠ è½½äº† ${data.codes.length} æ¡è®°å½•ï¼Œæ€»è®¡ ${data.pagination.total_items} æ¡`);
                } else {
                    throw new Error(data.message || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½é‚€è¯·ç å¤±è´¥:', error);
                showError('codes-table-body', 'åŠ è½½é‚€è¯·ç å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px;">
                        <div class="loader"></div>
                        <div style="margin-top: 15px; color: rgba(255,255,255,0.7);">åŠ è½½ä¸­...</div>
                    </td>
                </tr>
            `;
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: var(--danger-color);">
                        <i class="fa-solid fa-triangle-exclamation" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <div>${message}</div>
                        <button class="btn btn-outline" onclick="loadCodesData()" style="margin-top: 15px;">
                            <i class="fa-solid fa-rotate"></i> é‡è¯•
                        </button>
                    </td>
                </tr>
            `;
        }

        // æ›´æ–°é‚€è¯·ç è¡¨æ ¼
        // æ›´æ–°é‚€è¯·ç è¡¨æ ¼
        function updateCodesTable(codes) {
            const tbody = document.getElementById('codes-table-body');

            if (!codes || codes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">
                            <i class="fa-solid fa-inbox" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                            æš‚æ— é‚€è¯·ç æ•°æ®
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = codes.map(code => {
                // æ ¼å¼åŒ–ä¸€ä¸‹æ—¥æœŸå­—ç¬¦ä¸²ï¼Œä»¥ä¾¿ä¼ ç»™ JS å‡½æ•°
                let expireStr = code.expires_at ? code.expires_at.split(' ')[0] : ''; // å–å‡º YYYY-MM-DD

                return `
                <tr>
                    <td>${code.code || 'N/A'}</td>
                    <td>${code.created_at ? new Date(code.created_at).toLocaleString() : 'æœªçŸ¥'}</td>
                    <td>${code.expires_at ? new Date(code.expires_at).toLocaleString() : 'æ°¸ä¹…'}</td>
                    <td>
                        <span class="status-badge ${getCodeStatusClass(code)}">
                            ${getCodeStatusText(code)}
                        </span>
                    </td>
                    <td>${calculateRemainingDays(code.expires_at)}</td>
                    <td>
                        <button class="btn btn-outline" style="padding: 5px 10px; font-size: 12px;"
                                onclick="editCode('${code.code}', '${expireStr}')" title="ç¼–è¾‘">
                            <i class="fa-solid fa-edit"></i>
                        </button>
                        <button class="btn btn-outline" style="padding: 5px 10px; font-size: 12px;"
                                onclick="deleteCode('${code.code}')" title="åˆ é™¤">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
        }

        // åˆ†é¡µç›¸å…³å‡½æ•°
        function updateUsagePagination() {
            const pagination = paginationConfig.usage;
            const infoEl = document.getElementById('usage-page-info');
            const numbersEl = document.getElementById('usage-page-numbers');
            const prevBtn = document.querySelector('#usage-pagination .page-btn:nth-child(2)');
            const nextBtn = document.querySelector('#usage-pagination .page-btn:nth-child(4)');
            const firstBtn = document.querySelector('#usage-pagination .page-btn:nth-child(1)');
            const lastBtn = document.querySelector('#usage-pagination .page-btn:nth-child(5)');
            const pageInput = document.getElementById('usage-page-input');

            // æ›´æ–°ä¿¡æ¯
            infoEl.textContent = `ç¬¬ ${pagination.currentPage} é¡µï¼Œå…± ${pagination.totalPages} é¡µï¼Œæ€»è®¡ ${pagination.totalItems} æ¡`;

            // æ›´æ–°é¡µç è¾“å…¥æ¡†
            pageInput.value = pagination.currentPage;
            pageInput.max = pagination.totalPages;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            firstBtn.disabled = pagination.currentPage === 1;
            prevBtn.disabled = pagination.currentPage === 1;
            nextBtn.disabled = pagination.currentPage === pagination.totalPages;
            lastBtn.disabled = pagination.currentPage === pagination.totalPages;

            // æ›´æ–°é¡µç æ˜¾ç¤º
            numbersEl.innerHTML = '';
            const startPage = Math.max(1, pagination.currentPage - 2);
            const endPage = Math.min(pagination.totalPages, startPage + 4);

            for (let i = startPage; i <= endPage; i++) {
                const pageEl = document.createElement('span');
                pageEl.className = `page-number ${i === pagination.currentPage ? 'active' : ''}`;
                pageEl.textContent = i;
                pageEl.onclick = () => goToUsagePage(i);
                numbersEl.appendChild(pageEl);
            }
        }

        function updateCodesPagination() {
            const pagination = paginationConfig.codes;
            const infoEl = document.getElementById('codes-page-info');
            const numbersEl = document.getElementById('codes-page-numbers');
            const prevBtn = document.querySelector('#codes-pagination .page-btn:nth-child(2)');
            const nextBtn = document.querySelector('#codes-pagination .page-btn:nth-child(4)');
            const firstBtn = document.querySelector('#codes-pagination .page-btn:nth-child(1)');
            const lastBtn = document.querySelector('#codes-pagination .page-btn:nth-child(5)');
            const pageInput = document.getElementById('codes-page-input');

            // æ›´æ–°ä¿¡æ¯
            infoEl.textContent = `ç¬¬ ${pagination.currentPage} é¡µï¼Œå…± ${pagination.totalPages} é¡µï¼Œæ€»è®¡ ${pagination.totalItems} æ¡`;

            // æ›´æ–°é¡µç è¾“å…¥æ¡†
            pageInput.value = pagination.currentPage;
            pageInput.max = pagination.totalPages;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            firstBtn.disabled = pagination.currentPage === 1;
            prevBtn.disabled = pagination.currentPage === 1;
            nextBtn.disabled = pagination.currentPage === pagination.totalPages;
            lastBtn.disabled = pagination.currentPage === pagination.totalPages;

            // æ›´æ–°é¡µç æ˜¾ç¤º
            numbersEl.innerHTML = '';
            const startPage = Math.max(1, pagination.currentPage - 2);
            const endPage = Math.min(pagination.totalPages, startPage + 4);

            for (let i = startPage; i <= endPage; i++) {
                const pageEl = document.createElement('span');
                pageEl.className = `page-number ${i === pagination.currentPage ? 'active' : ''}`;
                pageEl.textContent = i;
                pageEl.onclick = () => goToCodesPage(i);
                numbersEl.appendChild(pageEl);
            }
        }

        // åˆ†é¡µå¯¼èˆªå‡½æ•° - ä½¿ç”¨çœŸå®API
        async function changeUsagePage(action) {
            const pagination = paginationConfig.usage;

            switch(action) {
                case 'first': pagination.currentPage = 1; break;
                case 'prev': pagination.currentPage = Math.max(1, pagination.currentPage - 1); break;
                case 'next': pagination.currentPage = Math.min(pagination.totalPages, pagination.currentPage + 1); break;
                case 'last': pagination.currentPage = pagination.totalPages; break;
            }

            await displayUsagePageData();
        }

        async function changeCodesPage(action) {
            const pagination = paginationConfig.codes;

            switch(action) {
                case 'first': pagination.currentPage = 1; break;
                case 'prev': pagination.currentPage = Math.max(1, pagination.currentPage - 1); break;
                case 'next': pagination.currentPage = Math.min(pagination.totalPages, pagination.currentPage + 1); break;
                case 'last': pagination.currentPage = pagination.totalPages; break;
            }

            await displayCodesPageData();
        }

        async function goToUsagePage(page) {
            const pagination = paginationConfig.usage;
            page = parseInt(page);
            if (page >= 1 && page <= pagination.totalPages) {
                pagination.currentPage = page;
                await displayUsagePageData();
            }
        }

        async function goToCodesPage(page) {
            const pagination = paginationConfig.codes;
            page = parseInt(page);
            if (page >= 1 && page <= pagination.totalPages) {
                pagination.currentPage = page;
                await displayCodesPageData();
            }
        }

        // æ˜¾ç¤ºå½“å‰é¡µæ•°æ® - ä½¿ç”¨çœŸå®API
        async function displayUsagePageData() {
            const pagination = paginationConfig.usage;

            try {
                // ä»APIè·å–å½“å‰é¡µæ•°æ®
                const response = await fetch(`/admin/api/dashboard/paginated?page=${pagination.currentPage}&page_size=${paginationConfig.pageSize}`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        const pageData = data.usage_data || [];
                        updateUsageTable(pageData);
                        updateUsagePagination();
                        return;
                    }
                }
            } catch (error) {
                console.error('åŠ è½½åˆ†é¡µæ•°æ®å¤±è´¥:', error);
            }

            // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®å›é€€
            const startIndex = (pagination.currentPage - 1) * paginationConfig.pageSize;
            const endIndex = startIndex + paginationConfig.pageSize;
            const pageData = pagination.data.slice(startIndex, endIndex);

            updateUsageTable(pageData);
            updateUsagePagination();
        }

        async function displayCodesPageData() {
            const pagination = paginationConfig.codes;
            const searchParam = pagination.searchTerm ? `&search=${encodeURIComponent(pagination.searchTerm)}` : '';

            try {
                // ä»APIè·å–å½“å‰é¡µæ•°æ®
                const response = await fetch(`/admin/codes/paginated?page=${pagination.currentPage}&page_size=${paginationConfig.pageSize}${searchParam}`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        const pageData = data.codes || [];
                        updateCodesTable(pageData);

                        // æ›´æ–°åˆ†é¡µä¿¡æ¯
                        pagination.totalItems = data.pagination.total_items;
                        pagination.totalPages = data.pagination.total_pages;

                        updateCodesPagination();
                        return;
                    }
                }
            } catch (error) {
                console.error('åŠ è½½åˆ†é¡µæ•°æ®å¤±è´¥:', error);
            }

            // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®å›é€€
            const dataToUse = pagination.searchTerm ? pagination.filteredData : pagination.data;
            const startIndex = (pagination.currentPage - 1) * paginationConfig.pageSize;
            const endIndex = startIndex + paginationConfig.pageSize;
            const pageData = dataToUse.slice(startIndex, endIndex);

            updateCodesTable(pageData);
            updateCodesPagination();
        }

        // æœç´¢å’Œç­›é€‰åŠŸèƒ½ - ä½¿ç”¨çœŸå®API
        async function searchCodes() {
            const searchTerm = document.getElementById('codes-search-input').value.trim();
            const pagination = paginationConfig.codes;

            pagination.searchTerm = searchTerm;
            pagination.currentPage = 1;

            try {
                const response = await fetch(`/admin/codes/paginated?page=1&page_size=${paginationConfig.pageSize}&search=${encodeURIComponent(searchTerm)}`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        pagination.filteredData = data.codes || [];
                        pagination.totalItems = data.pagination.total_items;
                        pagination.totalPages = data.pagination.total_pages;

                        updateCodesTable(pagination.filteredData);
                        updateCodesPagination();
                        return;
                    }
                }
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
            }

            // APIå¤±è´¥æ—¶çš„æœ¬åœ°æœç´¢
            if (searchTerm) {
                pagination.filteredData = pagination.data.filter(code =>
                    code.code.toLowerCase().includes(searchTerm.toLowerCase())
                );
                pagination.totalItems = pagination.filteredData.length;
            } else {
                pagination.totalItems = pagination.data.length;
            }

            pagination.totalPages = Math.ceil(pagination.totalItems / paginationConfig.pageSize);
            updateCodesTable(pagination.searchTerm ? pagination.filteredData : pagination.data);
            updateCodesPagination();
        }

        function filterCodes() {
            // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„ç­›é€‰é€»è¾‘
            alert('é«˜çº§ç­›é€‰åŠŸèƒ½å¾…å®ç°');
        }

        // è®¡ç®—å‰©ä½™å¤©æ•°
        function calculateRemainingDays(expiresAt) {
            if (!expiresAt) return 'æ°¸ä¹…';
            const now = new Date();
            const expireDate = new Date(expiresAt);
            const diffTime = expireDate - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) return 'å·²è¿‡æœŸ';
            return `${diffDays} å¤©`;
        }

        // è·å–é‚€è¯·ç çŠ¶æ€ç±»å
        function getCodeStatusClass(code) {
            if (!code.is_active) return 'status-expired';
            if (code.expires_at && new Date(code.expires_at) < new Date()) return 'status-expired';
            if (code.current_uses >= code.max_uses && code.max_uses > 0) return 'status-expired';
            return 'status-active';
        }

        // è·å–é‚€è¯·ç çŠ¶æ€æ–‡æœ¬
        function getCodeStatusText(code) {
            if (!code.is_active) return 'å·²ç¦ç”¨';
            if (code.expires_at && new Date(code.expires_at) < new Date()) return 'å·²è¿‡æœŸ';
            if (code.current_uses >= code.max_uses && code.max_uses > 0) return 'å·²ç”¨å®Œ';
            return 'æœ‰æ•ˆ';
        }

        // å·¥å…·å‡½æ•°
        function getStatusClass(item) {
            if (!item.is_active) return 'status-expired';
            if (item.expires_at && new Date(item.expires_at) < new Date()) return 'status-expired';
            return 'status-active';
        }

        function getStatusText(item) {
            if (!item.is_active) return 'å·²å¤±æ•ˆ';
            if (item.expires_at && new Date(item.expires_at) < new Date()) return 'å·²è¿‡æœŸ';
            return 'æœ‰æ•ˆ';
        }

        // ç¼–è¾‘é‚€è¯·ç ï¼ˆç¤ºä¾‹å‡½æ•°ï¼‰
        function editCode(code) {
            alert(`ç¼–è¾‘é‚€è¯·ç : ${code} - åŠŸèƒ½å¾…å®ç°`);
        }

        // åˆ é™¤é‚€è¯·ç ï¼ˆç¤ºä¾‹å‡½æ•°ï¼‰
        function deleteCode(code) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤é‚€è¯·ç  ${code} å—ï¼Ÿ`)) {
                alert(`åˆ é™¤é‚€è¯·ç : ${code} - åŠŸèƒ½å¾…å®ç°`);
            }
        }

        function showNotification(message, type = 'info') {
            // å®ç°é€šçŸ¥åŠŸèƒ½
            alert(`${type.toUpperCase()}: ${message}`);
        }

        function refreshData() {
            loadDashboardData();
            showNotification('æ•°æ®å·²åˆ·æ–°', 'success');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            // åˆå§‹åŒ–åˆ†é¡µæ˜¾ç¤º
            updateUsagePagination();
            updateCodesPagination();
        });
// ================= ğŸš€ æ–°å¢ï¼šç¼–è¾‘ä¸åˆ é™¤ JS é€»è¾‘ =================

        // 1. æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
        window.editCode = function(code, expiryDate) {
            document.getElementById('editModal').style.display = 'flex';
            document.getElementById('editCodeValue').value = code;
            document.getElementById('editCodeDisplay').value = code;
            document.getElementById('editExpiryDate').value = expiryDate || ''; // å¡«å…¥å½“å‰æ—¥æœŸ
            document.getElementById('resetDeviceCheck').checked = false; // é»˜è®¤ä¸å‹¾é€‰
        }

        function hideEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // 2. æäº¤ç¼–è¾‘è¡¨å•
        document.getElementById('editCodeForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const code = document.getElementById('editCodeValue').value;
            const newExpiry = document.getElementById('editExpiryDate').value;
            const resetDevice = document.getElementById('resetDeviceCheck').checked;

            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerText;
            submitBtn.innerText = 'ä¿å­˜ä¸­...';
            submitBtn.disabled = true;

            try {
                const response = await fetch('/admin/codes/update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        code: code,
                        new_expiry: newExpiry,
                        reset_device: resetDevice
                    })
                });
                const res = await response.json();

                if (res.success) {
                    showNotification('æ›´æ–°æˆåŠŸ', 'success');
                    hideEditModal();
                    loadCodesData(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    showNotification(res.message, 'error');
                }
            } catch (err) {
                showNotification('è¯·æ±‚å¤±è´¥: ' + err.message, 'error');
            } finally {
                submitBtn.innerText = originalText;
                submitBtn.disabled = false;
            }
        });

        // 3. åˆ é™¤é‚€è¯·ç é€»è¾‘
        window.deleteCode = async function(code) {
            if (!confirm(`âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦å½»åº•åˆ é™¤é‚€è¯·ç  [${code}] å—ï¼Ÿ\nåˆ é™¤åè¯¥ç å°†æ— æ³•å†ä½¿ç”¨ï¼Œä¸”æ— æ³•æ¢å¤ï¼`)) {
                return;
            }

            try {
                const response = await fetch('/admin/codes/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ code: code })
                });
                const res = await response.json();

                if (res.success) {
                    showNotification('åˆ é™¤æˆåŠŸ', 'success');
                    loadCodesData(); // åˆ·æ–°åˆ—è¡¨
                    loadDashboardData(); // åˆ·æ–°çœ‹æ¿ç»Ÿè®¡
                } else {
                    showNotification(res.message, 'error');
                }
            } catch (err) {
                showNotification('è¯·æ±‚å¤±è´¥: ' + err.message, 'error');
            }
        }
        // ================= ğŸš€ æ–°å¢ï¼šå¯¼å‡º Excel é€»è¾‘ =================

        function exportUsageData() {
            // 1. è·å–è¦å¯¼å‡ºçš„æ•°æ®
            // è¿™é‡Œæˆ‘ä»¬å¯¼å‡ºå½“å‰é¡µçš„æ•°æ®ï¼Œå¦‚æœä½ æƒ³å¯¼å‡ºæ‰€æœ‰æ•°æ®ï¼Œå¯èƒ½éœ€è¦è¯·æ±‚åç«¯çš„ä¸€ä¸ªæ–°æ¥å£
            // æš‚æ—¶å…ˆå¯¼å‡ºå½“å‰é¡µå±•ç¤ºçš„æ•°æ®
            const data = paginationConfig.usage.data;

            if (!data || data.length === 0) {
                showNotification('æš‚æ— æ•°æ®å¯å¯¼å‡º', 'warning');
                return;
            }

            // 2. æ ¼å¼åŒ–æ•°æ®ï¼Œå˜æˆ Excel éœ€è¦çš„äºŒç»´æ•°ç»„æˆ–å¯¹è±¡æ•°ç»„
            const exportData = data.map(item => {
                let status = 'æœªçŸ¥';
                if (!item.is_active) status = 'å·²ç¦ç”¨';
                else if (item.expires_at && new Date(item.expires_at) < new Date()) status = 'å·²è¿‡æœŸ';
                else status = 'æœ‰æ•ˆ';

                let devices = 'æ— ';
                try {
                    if (item.bound_devices) {
                        const d = typeof item.bound_devices === 'string' ? JSON.parse(item.bound_devices) : item.bound_devices;
                        if (Array.isArray(d)) devices = d.join(', ');
                    }
                } catch (e) {}

                return {
                    "é‚€è¯·ç ": item.code,
                    "åˆ›å»ºæ—¶é—´": item.created_at,
                    "è¿‡æœŸæ—¶é—´": item.expires_at || 'æ°¸ä¹…',
                    "çŠ¶æ€": status,
                    "ç»‘å®šè®¾å¤‡åˆ—è¡¨": devices
                };
            });

            // 3. åˆ›å»ºå·¥ä½œç°¿å’Œå·¥ä½œè¡¨
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);

            // 4. è®¾ç½®åˆ—å®½ (å¯é€‰)
            const wscols = [
                {wch: 20}, // é‚€è¯·ç 
                {wch: 20}, // åˆ›å»ºæ—¶é—´
                {wch: 20}, // è¿‡æœŸæ—¶é—´
                {wch: 10}, // çŠ¶æ€
                {wch: 50}  // è®¾å¤‡åˆ—è¡¨
            ];
            ws['!cols'] = wscols;

            // 5. å°†å·¥ä½œè¡¨æ·»åŠ åˆ°å·¥ä½œç°¿
            XLSX.utils.book_append_sheet(wb, ws, "ä½¿ç”¨æ•°æ®");

            // 6. ç”Ÿæˆæ–‡ä»¶åå¹¶ä¸‹è½½
            const dateStr = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `é‚€è¯·ç ä½¿ç”¨æ•°æ®_${dateStr}.xlsx`);

            showNotification('å¯¼å‡ºæˆåŠŸ', 'success');
        }
    </script>
</body>
</html>