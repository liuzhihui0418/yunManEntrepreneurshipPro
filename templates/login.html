<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘æ¼«å·¥åŠ AI ç³»ç»Ÿ - é‚€è¯·ç ç™»å½•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode_js@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {'spin-slow': 'spin 12s linear infinite'}
                }
            }
        }
    </script>

    <style>
        @keyframes flow-text {
            0% {
                background-position: 0% 50%;
            }
            100% {
                background-position: 200% 50%;
            }
        }

        .animate-flow-text {
            animation: flow-text 3s linear infinite;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        body {
            background-color: #000;
            overflow: hidden;
            margin: 0;
            font-family: sans-serif;
        }

        .modal-enter {
            animation: modalIn 0.3s ease-out forwards;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .hidden {
            display: none !important;
        }

        .loader {
            width: 20px;
            height: 20px;
            border: 2px solid #fff;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="text-gray-200">

<div class="relative w-screen h-screen p-[4px] overflow-hidden">
    <div class="absolute inset-0 bg-[conic-gradient(from_0deg,#06b6d4,#a855f7,#ec4899,#06b6d4)] animate-spin-slow blur-[10px] opacity-40 scale-[5]"></div>

    <div class="relative z-10 w-full h-full overflow-hidden flex flex-col items-center justify-center bg-black rounded-lg">
        <div class="absolute inset-0 z-0 select-none bg-black">
            <video src="https://img.yunmanybcz.chat/library/login_bg3.mp4"
                   autoplay loop muted playsinline
                   class="w-full h-full object-cover brightness-90 contrast-125 saturate-150"></video>
            <div class="absolute inset-0 z-20 bg-gradient-to-t from-black/95 via-transparent to-black/50"></div>
        </div>

        <div class="relative z-30 flex flex-col items-center text-center px-4 w-full max-w-7xl translate-y-10">
            <div class="relative mb-20 animate-fade-in-up">
                <h1 class="text-5xl md:text-8xl font-black italic tracking-[0.05em] text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-white via-purple-400 via-white to-cyan-300 bg-[length:200%_auto] animate-flow-text drop-shadow-[0_10px_20px_rgba(0,0,0,0.8)]">
                    äº‘æ¸¸ä¹¦æµ· æ¼«é—¯æœªæ¥
                </h1>
                <div class="absolute -bottom-4 left-1/2 -translate-x-1/2 w-3/4 h-[2px] bg-gradient-to-r from-transparent via-cyan-400 to-transparent animate-pulse"></div>
            </div>

            <div class="flex flex-col md:flex-row items-center gap-8 mb-12 animate-fade-in-up"
                 style="perspective: 1200px;">
                <button onclick="openModal('ç™»å½•')"
                        class="group/btn relative p-[3px] rounded-2xl overflow-hidden transition-all duration-500 hover:scale-105 active:scale-95 shadow-[0_0_30px_rgba(251,113,133,0.3)] w-full md:w-auto">
                    <div class="absolute inset-[-1000%] bg-[conic-gradient(from_0deg,#fb7185,transparent,transparent,#fb7185)] animate-[spin_3s_linear_infinite]"></div>
                    <div class="relative px-12 py-6 bg-[#080808]/95 backdrop-blur-xl rounded-[13px] flex items-center justify-center gap-3 min-w-[240px]">
                        <i class="fa-solid fa-right-to-bracket text-[#fb7185] text-xl"></i>
                        <span class="font-black text-white text-2xl tracking-[2px] italic">é‚€è¯·ç ç™»å½•</span>
                    </div>
                </button>

                <button onclick="openPricingModal()"
                        class="group/btn relative p-[3px] rounded-2xl overflow-hidden transition-all duration-500 hover:scale-105 active:scale-95 shadow-[0_0_30px_rgba(168,85,247,0.3)] w-full md:w-auto">
                    <div class="absolute inset-[-1000%] bg-[conic-gradient(from_0deg,#a855f7,transparent,transparent,#a855f7)] animate-[spin_3s_linear_infinite]"></div>
<!--                    <div class="relative px-12 py-6 bg-[#080808]/95 backdrop-blur-xl rounded-[13px] flex items-center justify-center gap-3 min-w-[240px]">-->
<!--                        <i class="fa-solid fa-gem text-purple-400 text-xl"></i>-->
<!--                        <span class="font-black text-white text-2xl tracking-[2px] italic">å……å€¼ç»­è´¹</span>-->
<!--                    </div>-->
                </button>

                <button onclick="toggleContact(true)"
                        class="group/btn relative p-[3px] rounded-2xl overflow-hidden transition-all duration-500 hover:scale-105 active:scale-95 shadow-[0_0_30px_rgba(249,115,22,0.3)] w-full md:w-auto">
                    <div class="absolute inset-[-1000%] bg-[conic-gradient(from_0deg,#f97316,transparent,transparent,#f97316)] animate-[spin_3s_linear_infinite]"></div>
                    <div class="relative px-12 py-6 bg-[#080808]/95 backdrop-blur-xl rounded-[13px] flex items-center justify-center gap-3 min-w-[240px]">
                        <i class="fa-solid fa-headset text-orange-400 text-xl"></i>
                        <span class="font-black text-white text-2xl tracking-[2px] italic">è”ç³»å®˜æ–¹å®¢æœ</span>
                    </div>
                </button>
            </div>
            <p class="mt-12 text-white/20 font-mono tracking-[1em] text-xs uppercase animate-pulse">YunMan GongFang AI
                System</p>
        </div>
    </div>
</div>

<div id="pricingModal"
     class="fixed inset-0 z-[100] flex items-center justify-center bg-black/30 backdrop-blur-[2px] hidden"
     onclick="closeAllModals()">
    <div class="relative w-full max-w-6xl p-[2px] rounded-[40px] overflow-hidden modal-enter mx-4"
         onclick="event.stopPropagation()">
        <div class="absolute inset-0 bg-[conic-gradient(from_0deg,#a855f7,#ec4899,#06b6d4,#a855f7)] animate-spin-slow opacity-80 scale-110"></div>

        <div class="relative bg-[#0A0A0F] p-8 md:p-14 rounded-[38px]">
            <button onclick="closeAllModals()"
                    class="absolute top-8 right-8 text-gray-500 hover:text-white transition-all">
                <i class="fa-solid fa-circle-xmark text-3xl"></i>
            </button>

            <div class="text-center mb-12 text-4xl font-black text-white italic tracking-[2px]">
                YunManGongFangAIç½‘é¡µé€šè¡Œè¯
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white/5 border border-white/10 p-6 rounded-3xl text-center flex flex-col justify-between">
                    <div>
                        <div class="text-purple-400 text-xs font-bold mb-3 tracking-[3px]">MONTHLY PASS</div>
                        <div class="text-4xl font-black text-white mb-4 italic">Â¥39.9<span
                                class="text-sm text-gray-500 not-italic">/æœˆ</span></div>
                        <ul class="text-gray-400 text-sm space-y-2 mb-8 text-left px-2">
                            <li><i class="fa-solid fa-check text-purple-500 mr-2"></i>è§£é”å…¨ç«™AIæ ¸å¿ƒåŠŸèƒ½ä½¿ç”¨æƒé™</li>
                            <li><i class="fa-solid fa-check text-purple-500 mr-2"></i>äº«å—æ¯æœˆåŸºç¡€äº‘ç«¯ç®—åŠ›è¡¥è´´</li>
                            <li><i class="fa-solid fa-check text-purple-500 mr-2"></i>æ”¯æŒç§»åŠ¨ç«¯ä¸ç½‘é¡µç«¯åŒæ­¥ç™»å½•</li>
                        </ul>
                    </div>
                    <button onclick="startBananaPay(39.9)"
                            class="w-full py-4 bg-white text-black font-black rounded-2xl hover:bg-purple-500 hover:text-white transition-all">
                        ç«‹å³è´­ä¹°æœˆå¡
                    </button>
                </div>

                <div class="relative bg-gradient-to-b from-blue-900/20 to-transparent border border-blue-500/30 p-6 rounded-3xl text-center flex flex-col justify-between shadow-[0_0_30px_rgba(59,130,246,0.2)]">
                    <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-blue-500 text-white text-[10px] px-3 py-1 rounded-full font-bold">
                        æœ€å—æ¬¢è¿
                    </div>
                    <div>
                        <div class="text-blue-400 text-xs font-bold mb-3 tracking-[3px]">ANNUAL PASS</div>
                        <div class="text-4xl font-black text-white mb-4 italic">Â¥299<span
                                class="text-sm text-gray-500 not-italic">/å¹´</span></div>
                        <ul class="text-gray-400 text-sm space-y-2 mb-8 text-left px-2">
                            <li><i class="fa-solid fa-check text-blue-500 mr-2"></i>å°Šäº«å¹´åº¦VIPæ ‡è¯†ä¸ä¸“å±é€šé“</li>
                            <li><i class="fa-solid fa-check text-blue-500 mr-2"></i>é¢å¤–èµ é€å¤§é¢åˆ›ä½œç®—åŠ›èµ„æºåŒ…</li>
                            <li><i class="fa-solid fa-check text-blue-500 mr-2"></i>ä¼˜å…ˆä½“éªŒç³»ç»Ÿå†…æµ‹ç‰ˆæ–°åŠŸèƒ½</li>
                        </ul>
                    </div>
                    <button onclick="startBananaPay(299.0)"
                            class="w-full py-4 bg-blue-600 text-white font-black rounded-2xl hover:bg-white hover:text-black transition-all">
                        å¼€å¯å¹´åº¦ç‰¹æƒ
                    </button>
                </div>

                <div class="bg-gradient-to-br from-purple-900/20 to-cyan-900/20 border border-cyan-500/30 p-6 rounded-3xl text-center flex flex-col justify-between">
                    <div>
                        <div class="text-cyan-400 text-xs font-bold mb-3 tracking-[3px]">FOREVER PASS</div>
                        <div class="text-4xl font-black text-white mb-4 italic">Â¥598<span
                                class="text-sm text-gray-500 not-italic">/æ°¸ä¹…</span></div>
                        <ul class="text-gray-400 text-sm space-y-2 mb-8 text-left px-2">
                            <li><i class="fa-solid fa-check text-cyan-500 mr-2"></i>ä¸€æ¬¡ä»˜è´¹ç»ˆèº«å…è´¹ä½¿ç”¨ç³»ç»Ÿ</li>
                            <li><i class="fa-solid fa-check text-cyan-500 mr-2"></i>åŒ…å«æ‰€æœ‰æœªæ¥æ›´æ–°çš„å¢å€¼æœåŠ¡</li>
                            <li><i class="fa-solid fa-check text-cyan-500 mr-2"></i>å°Šäº«é¡¶çº§é»‘é‡‘ä¼šå‘˜å®¢æœç›´è¿</li>
                        </ul>
                    </div>
                    <button onclick="startBananaPay(598.0)"
                            class="w-full py-4 bg-cyan-500 text-black font-black rounded-2xl hover:bg-white transition-all">
                        é¢†èµ°æ°¸ä¹…ç‰¹æƒ
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="payModal" class="fixed inset-0 z-[300] flex items-center justify-center bg-black/95 backdrop-blur-xl hidden">
    <div class="relative w-[400px] p-[2px] rounded-3xl overflow-hidden modal-enter shadow-[0_0_50px_rgba(59,130,246,0.5)]">
        <div class="absolute inset-0 bg-[conic-gradient(from_0deg,#3b82f6,#06b6d4,#3b82f6)] animate-spin-slow"></div>
        <div class="relative bg-[#0F0F13] p-10 rounded-[22px] flex flex-col items-center">
            <h3 class="text-2xl font-black text-white mb-4 italic">æ”¯ä»˜å®æ‰«ç æ”¯ä»˜</h3>
            <div id="qrcode" class="bg-white p-4 rounded-xl mb-6"></div>

            <div class="text-center mb-4">
                <span class="text-gray-400 text-xs uppercase tracking-widest">è®¢å•æœ‰æ•ˆæœŸå‰©ä½™</span>
                <div id="payCountdown" class="text-cyan-400 font-mono text-lg font-bold">10:00</div>
            </div>

            <p class="text-gray-400 text-xs mb-6 animate-pulse text-center leading-relaxed">
                æ”¯ä»˜æˆåŠŸåç³»ç»Ÿå°†è‡ªåŠ¨å‘æ”¾å¡å¯†<br>è¯·å‹¿å…³é—­æœ¬é¡µé¢
            </p>
            <button onclick="closePayModal()"
                    class="absolute top-4 right-4 text-gray-400 hover:text-white transition-all">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>
    </div>
</div>

<div id="loginModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm hidden"
     onclick="closeAllModals()">
    <div class="relative w-[500px] p-[2px] rounded-3xl overflow-hidden modal-enter shadow-[0_0_60px_rgba(139,92,246,0.3)]"
         onclick="event.stopPropagation()">
        <div class="absolute inset-0 bg-[conic-gradient(from_0deg,#8b5cf6,#06b6d4,#8b5cf6)] animate-spin-slow"></div>
        <div class="relative bg-[#0F0F13] p-12 rounded-[22px] flex flex-col items-center">
            <button onclick="closeAllModals()"
                    class="absolute top-8 right-8 text-gray-500 hover:text-white transition-all z-50">
                <i class="fa-solid fa-circle-xmark text-3xl"></i>
            </button>
            <h2 id="modalTitle" class="text-4xl font-black text-white italic tracking-wider mb-2">é‚€è¯·ç ç™»å½•</h2>
            <form onsubmit="handleValidateSubmit(event)" class="w-full space-y-8 mt-10">
                <div class="relative group">
                    <i class="fa-solid fa-key absolute left-5 top-1/2 -translate-y-1/2 text-gray-500 text-lg group-focus-within:text-cyan-400"></i>
                    <input id="inviteCode" type="text"
                           class="w-full bg-[#18181b] border border-white/10 text-white text-xl rounded-xl pl-14 pr-4 py-5 focus:outline-none focus:border-cyan-500/50 transition-all font-mono"
                           placeholder="è¯·è¾“å…¥é‚€è¯·ç " autocomplete="off">
                    <div id="errorMsg"
                         class="absolute -bottom-7 left-0 text-red-500 text-xs font-bold opacity-0 transition-opacity duration-300"></div>
                </div>
                <button id="submitBtn" type="submit"
                        class="w-full py-5 rounded-xl font-black text-xl tracking-[4px] bg-gradient-to-r from-cyan-500 to-purple-600 text-white transition-all active:scale-95 text-center">
                    ç¡®è®¤ç™»å½•
                </button>
            </form>
        </div>
    </div>
</div>

<div id="contactModal"
     class="fixed inset-0 z-[200] flex items-center justify-center bg-black/80 backdrop-blur-sm hidden"
     onclick="toggleContact(false)">
    <div class="relative w-full max-w-5xl p-[6px] rounded-3xl overflow-hidden modal-enter mx-4" onclick="event.stopPropagation()">
        <div class="absolute inset-0 bg-[conic-gradient(from_0deg,#f97316,#fbbf24,#f97316)] animate-spin-slow"></div>

        <div class="relative bg-[#0F0F13] p-12 rounded-[20px] flex flex-col items-center gap-10">
            <button onclick="toggleContact(false)"
                    class="absolute top-6 right-6 text-gray-600 hover:text-white transition-colors">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>

            <div class="text-center">
                <h3 class="text-4xl font-black text-white tracking-[4px] italic uppercase">
                    æ‰«ç è”ç³»YunManGongFangAIå®˜æ–¹å•†åŠ¡
                </h3>
                <p class="text-gray-500 text-base mt-3">è¯·æ ¹æ®æ‚¨çš„éœ€æ±‚æ‰«æä¸‹æ–¹äºŒç»´ç ï¼Œè¿›å…¥å®˜æ–¹æ¸ é“å­¦ä¹ åˆ›ä½œ</p>
            </div>

            <div class="flex flex-col md:flex-row items-center justify-center gap-10 w-full">

                <div class="flex flex-col items-center gap-4">
                    <div class="w-64 h-64 bg-white rounded-3xl p-3 shadow-inner overflow-hidden hover:scale-105 transition-transform duration-300">
                        <img src="https://img.yunmanybcz.chat/shangwu.png"
                             class="w-full h-full object-contain">
                    </div>
                    <span class="text-gray-400 font-bold text-lg tracking-widest">å•†åŠ¡å¯¹æ¥</span>
                </div>

                <div class="flex flex-col items-center gap-4">
                    <div class="w-64 h-64 bg-white rounded-3xl p-3 shadow-inner overflow-hidden hover:scale-105 transition-transform duration-300">
                        <img src="https://img.yunmanybcz.chat/weixin.jpg"
                             class="w-full h-full object-contain">
                    </div>
                    <span class="text-gray-400 font-bold text-lg tracking-widest">å…¬ä¼—å·</span>
                </div>

                <div class="flex flex-col items-center gap-4">
                    <div class="w-64 h-64 bg-white rounded-3xl p-3 shadow-inner overflow-hidden hover:scale-105 transition-transform duration-300">
                        <img src="https://img.yunmanybcz.chat/qiwei55.png"
                             class="w-full h-full object-contain">
                    </div>
                    <span class="text-gray-400 font-bold text-lg tracking-widest">å®˜æ–¹ä¼å¾®ç¾¤</span>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    /**
     * ğŸš€ å…³é”®ï¼šè‡ªåŠ¨è¯†åˆ« API åœ°å€
     * å¦‚æœæ˜¯ä» 139.199 è®¿é—®çš„ï¼Œå°±ç”¨å…¬ç½‘ï¼›å¦‚æœæ˜¯æœ¬åœ°è®¿é—®ï¼Œå°±ç”¨æœ¬åœ°ã€‚1
     */
    const API_BASE = window.location.protocol + "//" + window.location.host;

    let pollTimer = null;
    let countdownTimer = null; // ğŸš€ æ–°å¢ï¼šå€’è®¡æ—¶è®¡æ—¶å™¨å˜é‡

    // ---------------- ç»Ÿä¸€æ§åˆ¶é€»è¾‘ ----------------

    function openLoginModal() {
        closeAllModals();
        document.getElementById('loginModal').classList.remove('hidden');
    }

    function openPricingModal() {
        closeAllModals();
        document.getElementById('pricingModal').classList.remove('hidden');
    }

    // ç¡®ä¿è¿™ä¸ªå‡½æ•°åœ¨æ‚¨çš„ <script> æ ‡ç­¾é‡Œ
    function closeAllModals() {
        const modals = ['loginModal', 'pricingModal', 'contactModal', 'payModal'];
        modals.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.classList.add('hidden');
        });

        if (pollTimer) clearInterval(pollTimer);
        if (countdownTimer) clearInterval(countdownTimer); // ğŸš€ æ–°å¢ï¼šåœæ­¢å€’è®¡æ—¶
    }

    function toggleContact(show) {
        closeAllModals();
        if (show) document.getElementById('contactModal').classList.remove('hidden');
    }

    function closePayModal() {
        document.getElementById('payModal').classList.add('hidden');
        if (pollTimer) clearInterval(pollTimer);
    }

    // ---------------- æ”¯ä»˜ä¸è½®è¯¢ (Banana æ¥å£) ----------------

    async function startBananaPay(price) {
        closeAllModals();
        document.getElementById('payModal').classList.remove('hidden');
        const qrcodeEl = document.getElementById('qrcode');
        qrcodeEl.innerHTML = "<p class='text-black p-4 text-xs'>æ­£åœ¨åˆå§‹åŒ–...</p>";

        try {
            const res = await fetch(`${API_BASE}/api/banana_pay/create`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({price: price})
            });
            const data = await res.json();

            if (data.code === 200) {
                qrcodeEl.innerHTML = "";
                // 1. æ¸²æŸ“äºŒç»´ç 
                new QRCode(qrcodeEl, {text: data.qr_url, width: 200, height: 200});

                // 2. ğŸš€ å…³é”®ï¼šç«‹å³å¯åŠ¨å€’è®¡æ—¶ (600ç§’ = 10åˆ†é’Ÿ)
                startCountdown(600);

                // 3. å¯åŠ¨è½®è¯¢æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
                // 3. å¯åŠ¨è½®è¯¢æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
                // 3. å¯åŠ¨è½®è¯¢æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
                if (pollTimer) clearInterval(pollTimer);
                pollTimer = setInterval(async () => {
                    try {
                        // ğŸš€ å¢åŠ æ—¶é—´æˆ³é˜²æ­¢æµè§ˆå™¨ç¼“å­˜ç»“æœ
                        const statusRes = await fetch(`${API_BASE}/api/banana_pay/status/${data.order_no}?t=${Date.now()}`);
                        const statusData = await statusRes.json();

                        console.log("è½®è¯¢ä¸­...", statusData); // åœ¨æ§åˆ¶å°çœ‹çœ‹æœ‰æ²¡æœ‰æ”¶åˆ° true

                        if (statusData.paid === true || statusData.paid === "true") {
                            clearInterval(pollTimer);
                            if (countdownTimer) clearInterval(countdownTimer);

                            // ğŸš€ ç¡®ä¿è¿™é‡Œèƒ½æŠ“åˆ°çœŸæ­£çš„ card_key
                            const finalKey = statusData.card_key;

                            // æ›¿æ¢æ”¯ä»˜æ¡†å†…å®¹ä¸ºå¡å¯†å±•ç¤º
                            // ğŸš€ ä¿®æ­£é€‰æ‹©å™¨ï¼šä½¿ç”¨åæ–œæ è½¬ä¹‰ä¸­æ‹¬å·ï¼Œæˆ–è€…æ”¹ç”¨æ›´ç¨³å¥çš„è·å–æ–¹å¼
                            const payModalInner = document.querySelector('#payModal .relative.bg-\\[\\#0F0F13\\]');

                            // æˆ–è€…æœ€ä¿é™©çš„æ–¹æ³•ï¼Œç›´æ¥æ ¹æ®å±‚çº§æ‰¾ï¼š
                            // const payModalInner = document.querySelector('#payModal .relative.bg-black');
                            if (payModalInner) {
                                payModalInner.innerHTML = `
                                                    <div class="flex flex-col items-center animate-fade-in-up">
                                                        <div class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mb-6">
                                                            <i class="fa-solid fa-check text-green-500 text-3xl"></i>
                                                        </div>
                                                        <h3 class="text-2xl font-black text-white mb-2 italic">è´­ä¹°æˆåŠŸï¼</h3>
                                                        <p class="text-gray-400 text-sm mb-6">è¯·åŠ¡å¿…æˆªå›¾ä¿å­˜æ‚¨çš„å¡å¯†</p>
                                                        <div class="w-full bg-white/5 border-2 border-dashed border-cyan-500/50 p-6 rounded-2xl mb-8 text-center">
                                                            <span class="text-3xl font-black text-white tracking-widest font-mono">${finalKey}</span>
                                                        </div>
                                                        <div class="grid grid-cols-2 gap-4 w-full">
                                                            <button onclick="copyKey('${finalKey}')" class="py-4 bg-white/10 text-white rounded-xl font-bold">å¤åˆ¶å¡å¯†</button>
                                                            <button onclick="autoLoginWithKey('${finalKey}')" class="py-4 bg-gradient-to-r from-cyan-500 to-blue-600 text-white rounded-xl font-bold">ç«‹å³ç™»å½•</button>
                                                        </div>
                                                    </div>`;
                            }
                        }
                    } catch (e) {
                        console.warn("åŒæ­¥çŠ¶æ€ä¸­...");
                    }
                }, 2500); // ç¨å¾®åŠ å¿«è½®è¯¢é€Ÿåº¦
            } else {
                alert("ä¸‹å•å¤±è´¥ï¼š" + (data.msg || "æ¥å£ç¹å¿™"));
                closePayModal();
            }
        } catch (e) {
            alert("æ— æ³•è¿æ¥æ”¯ä»˜æœåŠ¡å™¨");
            closePayModal();
        }
    }

    // ğŸš€ æ–°å¢ï¼šä¸€é”®å¤åˆ¶åŠŸèƒ½
    // ğŸš€ ä¿®æ­£åçš„å¤åˆ¶å‡½æ•°ï¼šå»æ‰ event ä¾èµ–ï¼Œæ”¹ç”¨æ›´ç¨³å¥çš„æç¤ºæ–¹å¼
    function copyKey(text) {
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => {
            // ä½¿ç”¨ç®€å•çš„å¼¹çª—æç¤ºï¼Œé¿å…æ“ä½œ DOM å˜é‡å¯¼è‡´çš„æŠ¥é”™
            alert("å¡å¯†å·²æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
        }).catch(err => {
            console.error("å¤åˆ¶å¤±è´¥:", err);
            // å…¼å®¹æ€§å¤‡é€‰æ–¹æ¡ˆ
            const input = document.createElement('input');
            input.setAttribute('value', text);
            document.body.appendChild(input);
            input.select();
            document.execCommand('copy');
            document.body.removeChild(input);
            alert("å¡å¯†å·²å¤åˆ¶");
        });
    }

    // ğŸš€ æ–°å¢ï¼šè‡ªåŠ¨å¡«å…¥å¡å¯†å¹¶æ‰§è¡Œç™»å½•è·³è½¬
    async function autoLoginWithKey(key) {
        // 1. å…³é—­æ”¯ä»˜æ¡†å¹¶æ‰“å¼€ç™»å½•æ¡†
        closeAllModals();
        document.getElementById('loginModal').classList.remove('hidden');

        // 2. å¡«å…¥é‚€è¯·ç 
        const inviteInput = document.getElementById('inviteCode');
        inviteInput.value = key;

        // 3. è§¦å‘ç™»å½•éªŒè¯é€»è¾‘ (å¤ç”¨ä½ ç°æœ‰çš„ handleValidateSubmit)
        // æ„é€ ä¸€ä¸ªæ¨¡æ‹Ÿçš„ Event å¯¹è±¡
        const mockEvent = {
            preventDefault: () => {
            }
        };
        handleValidateSubmit(mockEvent);
    }
    // ğŸš€ æ–°å¢ï¼šå€’è®¡æ—¶å¤„ç†å‡½æ•°
    function startCountdown(durationSeconds) {
        let timer = durationSeconds;
        const display = document.getElementById('payCountdown');

        if (countdownTimer) clearInterval(countdownTimer);

        countdownTimer = setInterval(() => {
            let minutes = Math.floor(timer / 60);
            let seconds = timer % 60;

            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            display.textContent = minutes + ":" + seconds;

            if (--timer < 0) {
                clearInterval(countdownTimer);
                display.textContent = "å·²è¿‡æœŸ";
                alert("è®¢å•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ä¸‹å•");
                closeAllModals();
            }
        }, 1000);
    }

    // ---------------- é‚€è¯·ç ç™»å½• ( handleValidateSubmit ) ----------------

    async function handleValidateSubmit(e) {
        e.preventDefault();
        const code = document.getElementById('inviteCode').value.trim();
        const btn = document.getElementById('submitBtn');

        if (!code || code.length < 4) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚€è¯·ç ');
            return;
        }

        btn.disabled = true;
        const originalText = btn.innerText;
        btn.innerHTML = '<span class="loader mr-2"></span> éªŒè¯ä¸­...';

        try {
            // ================= ğŸš€ æ–°å¢å¼€å§‹ï¼šè·å–è®¾å¤‡æŒ‡çº¹ =================
            const fpPromise = FingerprintJS.load();
            const fp = await fpPromise;

            // ğŸ‘‡ ä¿®æ”¹è¿™é‡Œï¼šæŠŠ result æ”¹åä¸º fpResult
            const fpResult = await fp.get();
            const deviceId = fpResult.visitorId;
            // ================= ğŸš€ æ–°å¢ç»“æŸ =================

            const response = await fetch(`${API_BASE}/api/validate`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    invite_code: code,
                    device_id: deviceId  // <--- å…³é”®ï¼šæŠŠç”Ÿæˆçš„è®¾å¤‡IDå‘ç»™åç«¯
                })
            });

            // ğŸ‘‡ ä¸‹é¢è¿™è¡Œä¸ç”¨åŠ¨ï¼Œç»§ç»­ä½¿ç”¨ result å˜é‡å
            const result = await response.json();

            if (result.success) {
                document.cookie = `session_id=${result.session_id}; path=/; max-age=86400`;
                window.location.href = '/';
            } else {
                alert(result.message || 'é‚€è¯·ç æ— æ•ˆ');
                btn.disabled = false;
                btn.innerText = originalText;
            }
        } catch (error) {
            console.error("è¯·æ±‚å¤±è´¥:", error);
            alert('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨æˆ–è®¾å¤‡éªŒè¯å¤±è´¥');
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }

    // è¾…åŠ©å…¼å®¹å‡½æ•°ï¼šå¦‚æœè€çš„ openModal è¢«ç‚¹å‡»
    window.openModal = function (type) {
        if (type === 'å……å€¼') openPricingModal();
        else openLoginModal();
    }
</script>
</body>
</html>